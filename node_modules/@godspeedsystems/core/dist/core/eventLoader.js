/*
 * You are allowed to study this software for learning and local * development purposes only. Any other use without explicit permission by Mindgrep, is prohibited.
 * Â© 2022 Mindgrep Technologies Pvt Ltd
 */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return loadEvents;
    }
});
const _utils = require("./utils");
const _yamlLoader = /*#__PURE__*/ _interop_require_default(require("./yamlLoader"));
const _jsonSchemaValidation = require("./jsonSchemaValidation");
const _expandVariables = /*#__PURE__*/ _interop_require_default(require("./expandVariables"));
const _logger = require("../logger");
function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {
    try {
        var info = gen[key](arg);
        var value = info.value;
    } catch (error) {
        reject(error);
        return;
    }
    if (info.done) {
        resolve(value);
    } else {
        Promise.resolve(value).then(_next, _throw);
    }
}
function _async_to_generator(fn) {
    return function() {
        var self = this, args = arguments;
        return new Promise(function(resolve, reject) {
            var gen = fn.apply(self, args);
            function _next(value) {
                asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value);
            }
            function _throw(err) {
                asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err);
            }
            _next(undefined);
        });
    };
}
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const rewiteRefsToAbsolutePath = (events)=>{
    if (!Object.keys(events).length) {
        // there are no events
        return;
    }
    // deep copy
    _logger.logger.debug('Replacing $refs in events with definitions.');
    const deepCopyOfEvents = JSON.parse(JSON.stringify(events));
    return Object.keys(deepCopyOfEvents).reduce((accumulator, eventKey)=>{
        var _eventObject_body, _eventObject_data_body, _eventObject_data, _eventObject_data_schema, _eventObject_data1;
        let eventObject = deepCopyOfEvents[eventKey];
        _logger.logger.debug('eventObject %o', eventObject);
        const bodyContent = (eventObject === null || eventObject === void 0 ? void 0 : (_eventObject_body = eventObject.body) === null || _eventObject_body === void 0 ? void 0 : _eventObject_body.content) || (eventObject === null || eventObject === void 0 ? void 0 : (_eventObject_data = eventObject.data) === null || _eventObject_data === void 0 ? void 0 : (_eventObject_data_body = _eventObject_data.body) === null || _eventObject_data_body === void 0 ? void 0 : _eventObject_data_body.content);
        if (bodyContent) {
            Object.keys(bodyContent).forEach((contentType)=>{
                let contentSchema = bodyContent[contentType].schema;
                if (contentSchema) {
                    if (contentSchema.hasOwnProperty('$ref')) {
                        const defKey = contentSchema.$ref;
                        contentSchema.$ref = 'https://godspeed.systems/definitions.json' + defKey;
                        bodyContent[contentType].schema = contentSchema;
                    }
                }
            });
        }
        const responses = (eventObject === null || eventObject === void 0 ? void 0 : eventObject.responses) || (eventObject === null || eventObject === void 0 ? void 0 : (_eventObject_data1 = eventObject.data) === null || _eventObject_data1 === void 0 ? void 0 : (_eventObject_data_schema = _eventObject_data1.schema) === null || _eventObject_data_schema === void 0 ? void 0 : _eventObject_data_schema.responses);
        _logger.logger.debug('responses %o', responses);
        if (responses) {
            Object.keys(responses).forEach((responseCode)=>{
                let responseContent = responses[responseCode].content;
                _logger.logger.debug('responseContent %o', responseContent);
                if (responseContent) {
                    Object.keys(responseContent).forEach((responseContentType)=>{
                        let responseContentTypeSchema = responseContent[responseContentType].schema;
                        if (responseContentTypeSchema) {
                            if (responseContentTypeSchema.hasOwnProperty('$ref')) {
                                const defKey = responseContentTypeSchema.$ref;
                                responseContentTypeSchema.$ref = 'https://godspeed.systems/definitions.json' + defKey;
                                responses[responseCode].content[responseContentType].schema = responseContentTypeSchema;
                            }
                        }
                    });
                }
            });
        }
        accumulator[eventKey] = eventObject;
        return accumulator;
    }, {});
};
function loadEvents(functions, pathString) {
    return _loadEvents.apply(this, arguments);
}
function _loadEvents() {
    _loadEvents = _async_to_generator(function*(functions, pathString) {
        const events = yield (0, _yamlLoader.default)(pathString, true);
        if (events && !Object.keys(events).length) {
            throw new Error(`There are no events defined in events dir: ${pathString}`);
        }
        _logger.logger.debug('events %o', events);
        const evalEvents = (0, _expandVariables.default)(rewiteRefsToAbsolutePath(events));
        const checkFn = (0, _utils.checkFunctionExists)(events, functions);
        if (!checkFn.success) {
            throw new Error(`Error in loading functions for events. Error message: %s. Exiting. ${checkFn.message}`);
        }
        if (evalEvents) {
            yield (0, _jsonSchemaValidation.loadJsonSchemaForEvents)(evalEvents);
        }
        return evalEvents;
    });
    return _loadEvents.apply(this, arguments);
}
