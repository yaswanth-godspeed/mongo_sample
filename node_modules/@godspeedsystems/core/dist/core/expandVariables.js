/*
* You are allowed to study this software for learning and local * development purposes only. Any other use without explicit permission by Mindgrep, is prohibited.
* Â© 2022 Mindgrep Technologies Pvt Ltd
*/ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return compileScript;
    }
});
const _config = /*#__PURE__*/ _interop_require_default(require("config"));
const _mappingLoader = /*#__PURE__*/ _interop_require_default(require("./mappingLoader"));
const _logger = require("../logger");
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const mappings = (0, _mappingLoader.default)();
function substitute(value) {
    try {
        if (value.match(/<(.*?)%/)) {
            _logger.logger.debug('value before %s', value);
            let script = value.replace(/"?<(.*?)%\s*(.*?)\s*%>"?/, '$2');
            //TODO: pass other context variables
            value = Function('config', 'mappings', 'return ' + script)(_config.default, mappings);
            _logger.logger.debug('value after %s', value);
        }
    } catch (ex) {
    //console.error(ex);
    }
    return value;
}
function compileScript(args) {
    if (!args) {
        return args;
    }
    if (typeof args == 'object') {
        if (!Array.isArray(args)) {
            let out = {};
            for(let k in args){
                out[k] = compileScript(args[k]);
            }
            return out;
        } else {
            let out = [];
            for(let k in args){
                out[k] = compileScript(args[k]);
            }
            return out;
        }
    } else if (typeof args == 'string') {
        return substitute(args);
    }
    return args;
}
